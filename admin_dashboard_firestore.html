<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMS Admin Dashboard - Realtime Firestore</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide icons for clean, professional icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- FIREBASE SDK IMPORTS (MUST BE TYPE="MODULE") -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, setDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        // Your specific Firebase configuration (corrected format)
        const firebaseConfig = {
            apiKey: "AIzaSyDKjvdM56mwcRWStPw24ptnAd-A-_0pkV8",
            authDomain: "portal-website-38ab1.firebaseapp.com",
            projectId: "portal-website-38ab1",
            storageBucket: "portal-website-38ab1.firebasestorage.app",
            messagingSenderId: "812898135005",
            appId: "1:812898135005:web:6373ea73c695e61dcc2434",
            measurementId: "G-RY8L40QL75"
        };
        
        // Expose Firebase functions to the global scope for use in non-module scripts
        window.FirebaseServices = { 
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged, setLogLevel,
            getFirestore, collection, onSnapshot, doc, addDoc, setDoc, deleteDoc, serverTimestamp,
            getAnalytics,
            firebaseConfig // <-- Expose the configuration
        };
    </script>
    
    <style>
        :root {
            font-family: 'Inter', sans-serif;
            --teal-500: #14b8a6;
        }
        #sidebar {
            transition: transform 0.3s ease-in-out;
        }
        #main-app-container.logged-in {
            display: flex;
        }
        .rich-text-editor-textarea {
            min-height: 400px;
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'dark-bg': '#111827',
                        'dark-card': '#1f2937',
                    },
                }
            }
        }
    </script>
</head>
<body class="transition-colors duration-300">

    <div id="app-root" class="min-h-screen">
        <div class="flex items-center justify-center h-screen bg-gray-100 dark:bg-gray-900">
            <div class="text-center p-6 bg-white dark:bg-gray-800 rounded-xl shadow-xl">
                <div class="animate-spin h-8 w-8 border-4 border-teal-500 border-t-transparent rounded-full mx-auto mb-4"></div>
                <p class="text-lg font-semibold text-gray-700 dark:text-gray-300">Connecting to CMS...</p>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-2" id="auth-status">Authenticating user...</p>
            </div>
        </div>
    </div>

    <script type="module">
        // Import all exposed Firebase functions from the type="module" script block
        const { 
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged,
            getFirestore, collection, onSnapshot, doc, addDoc, setDoc, deleteDoc, serverTimestamp, setLogLevel,
            getAnalytics,
            firebaseConfig
        } = window.FirebaseServices;
        
        // --- GLOBAL FIREBASE REFERENCES ---
        let db;
        let auth;
        let appId;
        let userId;

        // --- GLOBAL APP STATE ---
        let isLoggedIn = false;
        // The role is hardcoded as Admin for the UI/permissions, since we use anonymous sign-in now.
        let userRole = 'Admin'; 
        let articles = []; 
        let currentPage = 'overview';
        let isSidebarOpen = false;
        let editingArticle = null;
        
        // --- MOCK DATA (Only for Users/Categories) ---
        const MOCK_ARTICLES = [
            { title: 'AI Breakthrough: New Model Predicts Election Results', category: 'Tech', status: 'Published', views: 5200, readTime: 7 },
            { title: 'Local Council Debates New Park Construction', category: 'Politics', status: 'Draft', views: 50, readTime: 3 },
            { title: 'Quarterly Earnings Report: Tech Sector Soars', category: 'Business', status: 'Pending Review', views: 1200, readTime: 5 },
            { title: 'The Best Summer Road Trips in the West', category: 'Lifestyle', status: 'Published', views: 8000, readTime: 8 }
        ];
        const MOCK_CATEGORIES = [
            { name: 'Politics', color: 'bg-red-500', icon: 'zap' },
            { name: 'Business', color: 'bg-green-500', icon: 'dollar-sign' },
            { name: 'World', color: 'bg-blue-500', icon: 'globe' },
            { name: 'Tech', color: 'bg-indigo-500', icon: 'cpu' },
            { name: 'Sports', color: 'bg-yellow-500', icon: 'trophy' },
            { name: 'Lifestyle', color: 'bg-pink-500', icon: 'heart' },
        ];
        const MOCK_USERS = [
            { id: 101, name: 'Ava Miller', email: 'ava@chronicle.com', role: 'Admin', status: 'Active' },
            { id: 102, name: 'Ben Carter', email: 'ben@chronicle.com', role: 'Editor', status: 'Active' },
            { id: 103, name: 'Chloe Davis', email: 'chloe@chronicle.com', role: 'Writer', status: 'Active' },
        ];

        // --- CORE FIREBASE FUNCTIONS ---

        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initFirebase() {
            try {
                // 1. Setup Environment Variables (Using hardcoded config)
                appId = firebaseConfig.projectId; // Use projectId as a simple appId
                
                // 2. Initialize App, Services, and Analytics
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                const analytics = getAnalytics(app); // INITIALIZE ANALYTICS
                setLogLevel('error'); 

                const statusEl = document.getElementById('auth-status');

                // 3. Handle Authentication: Using Anonymous Sign-in for simplified testing
                statusEl.textContent = 'Signing in anonymously (CMS Mode)...';
                await signInAnonymously(auth);

                // 4. Final Auth Check and Setup
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isLoggedIn = true;
                        statusEl.textContent = `User ${user.uid} signed in. Loading content...`;
                        setupArticleListener(); 
                        window.renderApp();     
                    } else {
                        isLoggedIn = false;
                        userId = null;
                        statusEl.textContent = 'Authentication failed. Please refresh.';
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization/Authentication Error:", error);
                document.getElementById('auth-status').textContent = `Authentication failed: ${error.message}`;
            }
        }

        /**
         * Sets up the real-time listener for CMS articles.
         */
        function setupArticleListener() {
            if (!db || !userId) {
                console.error("Firestore or User ID not available for listener setup.");
                return;
            }

            // Path for public data shared across users for this app
            const collectionPath = `artifacts/${appId}/public/data/cms_articles`;
            const articlesRef = collection(db, collectionPath);
            
            // Listen for changes in real-time
            onSnapshot(articlesRef, (snapshot) => {
                const newArticles = [];
                snapshot.forEach(doc => {
                    newArticles.push({
                        id: doc.id, 
                        ...doc.data()
                    });
                });
                
                newArticles.sort((a, b) => b.date ? b.date.toDate().getTime() : 0 - (a.date ? a.date.toDate().getTime() : 0));
                
                articles = newArticles;
                window.renderContent(); 

                if (articles.length === 0) {
                    if (localStorage.getItem('cms_populated') !== 'true') {
                        populateMockArticles();
                        localStorage.setItem('cms_populated', 'true');
                    }
                }
            }, (error) => {
                console.error("Firestore Listener Error:", error);
            });
        }
        
        /**
         * Adds mock data to Firestore if the collection is empty. (Runs once)
         */
        async function populateMockArticles() {
             const collectionPath = `artifacts/${appId}/public/data/cms_articles`;
             const articlesRef = collection(db, collectionPath);

             for (const mock of MOCK_ARTICLES) {
                 const articleData = {
                     title: mock.title,
                     category: mock.category,
                     status: mock.status,
                     views: mock.views,
                     readTime: mock.readTime,
                     authorId: userId,
                     authorName: MOCK_USERS.find(u => u.role === userRole)?.name || 'Admin User',
                     date: serverTimestamp(), // Use server timestamp for consistency
                     content: "This is sample article content loaded during initialization. Edit me to save new content!",
                 };
                 await addDoc(articlesRef, articleData);
             }
             console.log("Mock articles populated to Firestore.");
        }

        /**
         * Saves or updates an article in Firestore.
         */
        async function saveArticle(title, category, content, currentId) {
            const collectionPath = `artifacts/${appId}/public/data/cms_articles`;
            const articleData = {
                title: title,
                category: category,
                content: content,
                status: 'Draft', 
                authorId: userId,
                authorName: MOCK_USERS.find(u => u.role === userRole)?.name || 'Admin User',
                readTime: Math.ceil(content.length / 1000) * 5, 
                
                date: currentId === 'new' ? serverTimestamp() : articles.find(a => a.id === currentId)?.date,
                views: currentId === 'new' ? 0 : articles.find(a => a.id === currentId)?.views || 0,
            };

            try {
                if (currentId === 'new') {
                    const docRef = await addDoc(collection(db, collectionPath), articleData);
                    console.log("New article added!", docRef.id);
                } else {
                    const articleRef = doc(db, collectionPath, currentId);
                    await setDoc(articleRef, articleData, { merge: true });
                    console.log(`Article ${currentId} updated!`);
                }
                
                window.setEditingArticle(null); 
            } catch (e) {
                console.error("Error saving document: ", e);
            }
        }
        
        /**
         * Deletes an article from Firestore.
         */
        async function deleteArticle(articleId) {
            if (!confirm('Are you sure you want to delete this article? This cannot be undone.')) return;
            try {
                const collectionPath = `artifacts/${appId}/public/data/cms_articles`;
                await deleteDoc(doc(db, collectionPath, articleId));
                console.log(`Article ${articleId} deleted successfully.`);
            } catch (e) {
                console.error("Error deleting document: ", e);
            }
        }
        
        // Expose functions needed by global scope (non-module script)
        window.initFirebase = initFirebase;
        window.handleLogout = () => { console.log('Simulating Logout'); }; 
        window.getRoleRank = (role) => {
            if (role === 'Admin') return 3;
            if (role === 'Editor') return 2;
            return 1; // Writer
        };
        window.userRole = userRole;
        window.MOCK_CATEGORIES = MOCK_CATEGORIES;
        window.MOCK_USERS = MOCK_USERS;
        window.articles = articles; 
        window.saveArticle = saveArticle;
        window.deleteArticle = deleteArticle;

    </script>


    <!-- START NON-MODULE (MAIN UI LOGIC) SCRIPT -->
    <script>
        // --- GLOBAL APP STATE (Re-declared for access) ---
        let currentPage = 'overview';
        let isSidebarOpen = false;
        let editingArticle = null;

        // --- AUTHENTICATION & GLOBAL STATE FUNCTIONS (Simplified/Bound) ---
        
        function handleLogin() { 
            console.log('Firebase auth successful. Rendering app.');
            window.renderApp(); 
        }

        function toggleSidebar() {
            isSidebarOpen = !isSidebarOpen;
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                sidebar.classList.toggle('-translate-x-full', !isSidebarOpen);
            }
            const backdrop = document.getElementById('sidebar-backdrop');
            if (backdrop) {
                backdrop.classList.toggle('hidden', !isSidebarOpen);
            }
        }

        function setCurrentPage(pageKey) {
            currentPage = pageKey;
            editingArticle = null;
            window.renderContent();
            if (isSidebarOpen) {
                toggleSidebar();
            }
        }

        function setEditingArticle(article) {
            editingArticle = article;
            window.renderContent();
        }

        // --- PAGE RENDERING UTILITIES ---
        
        function renderIcon(iconName, classNames) {
            return `<i data-lucide="${iconName.toLowerCase()}" class="${classNames}"></i>`;
        }
        
        function createStatCard(title, value, iconName, colorClass, delta) {
            const deltaHtml = delta ? `
                <span class="text-sm font-semibold ${delta > 0 ? 'text-green-500' : 'text-red-500'} flex items-center">
                    ${renderIcon(delta > 0 ? 'trending-up' : 'chevron-down', 'w-4 h-4 mr-1')}
                    ${Math.abs(delta)}%
                </span>
            ` : '';

            return `
                <div class="bg-white dark:bg-dark-card p-5 rounded-xl shadow-lg border-t-4 transition duration-300 hover:shadow-2xl" style="border-color: ${colorClass.split('-')[1]}">
                    <div class="flex items-center justify-between">
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">${title}</p>
                        ${renderIcon(iconName, `w-6 h-6 ${colorClass}`)}
                    </div>
                    <div class="mt-1 flex items-end justify-between">
                        <p class="text-3xl font-bold text-gray-900 dark:text-white">${value.toLocaleString()}</p>
                        ${deltaHtml}
                    </div>
                </div>
            `;
        }

        function getStatusBadge(status) {
            let colors = '';
            if (status === 'Published') { colors = 'bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-100'; } 
            else if (status === 'Draft') { colors = 'bg-yellow-100 text-yellow-800 dark:bg-yellow-800 dark:text-yellow-100'; } 
            else if (status === 'Pending Review') { colors = 'bg-blue-100 text-blue-800 dark:bg-blue-800 dark:text-blue-100'; } 
            else if (status === 'Admin') { colors = 'bg-red-100 text-red-800 dark:bg-red-800 dark:text-red-100'; } 
            else if (status === 'Editor') { colors = 'bg-amber-100 text-amber-800 dark:bg-amber-800 dark:text-amber-100'; } 
            else if (status === 'Writer') { colors = 'bg-indigo-100 text-indigo-800 dark:bg-indigo-800 dark:text-indigo-100'; } 
            else if (status === 'Active') { colors = 'bg-teal-100 text-teal-800 dark:bg-teal-800 dark:text-teal-100'; } 
            else if (status === 'Inactive') { colors = 'bg-gray-100 text-gray-800 dark:bg-gray-600 dark:text-gray-100'; }

            return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${colors}">${status}</span>`;
        }

        // --- PAGE RENDERERS ---

        function renderSidebar() {
            const navItems = [
                { name: 'Dashboard', icon: 'LayoutGrid', page: 'overview', requiredRole: 'Writer' },
                { name: 'Article Management', icon: 'FileText', page: 'articles', requiredRole: 'Writer' },
                { name: 'Media Library', icon: 'Image', page: 'media', requiredRole: 'Writer' },
                { name: 'Categories & Tags', icon: 'Tags', page: 'categories', requiredRole: 'Editor' },
                { name: 'User Management', icon: 'Users', page: 'users', requiredRole: 'Admin' },
                { name: 'Settings', icon: 'Settings', page: 'settings', requiredRole: 'Admin' },
            ];

            const canAccess = (requiredRole) => window.getRoleRank(window.userRole) >= window.getRoleRank(requiredRole);

            const navHtml = navItems.filter(item => canAccess(item.requiredRole)).map((item) => {
                const isActive = currentPage === item.page;
                return `
                    <button
                        onclick="window.setCurrentPage('${item.page}')"
                        class="w-full flex items-center p-3 rounded-lg transition duration-150 ${
                            isActive ? 'bg-teal-600 text-white shadow-md' : 'text-gray-300 hover:bg-gray-800 hover:text-teal-400'
                        }"
                    >
                        ${renderIcon(item.icon, 'w-5 h-5 mr-3')}
                        <span class="font-medium">${item.name}</span>
                        ${item.requiredRole !== 'Writer' ? `
                            <span class="ml-auto text-xs font-bold px-2 py-0.5 rounded-full ${item.requiredRole === 'Admin' ? 'bg-red-500' : 'bg-amber-500'}">
                                ${item.requiredRole}
                            </span>` : ''
                        }
                    </button>
                `;
            }).join('');

            return `
                <!-- Backdrop for mobile -->
                <div id="sidebar-backdrop" onclick="window.toggleSidebar()" class="fixed inset-0 bg-black bg-opacity-50 z-20 lg:hidden hidden"></div>

                <div id="sidebar" class="w-64 flex-shrink-0 bg-gray-900 dark:bg-gray-900 text-white flex flex-col h-full fixed lg:relative z-30 transition-transform duration-300 transform -translate-x-full lg:translate-x-0">
                    <!-- Logo -->
                    <div class="p-6 border-b border-gray-800 flex items-center space-x-2">
                        ${renderIcon('file-text', 'w-6 h-6 text-teal-400')}
                        <span class="text-xl font-bold">CMS Portal</span>
                    </div>

                    <!-- User Info -->
                    <div class="p-6 border-b border-gray-800 space-y-1">
                        <p class="text-lg font-semibold text-white">Welcome, ${window.userRole}!</p>
                        <p class="text-xs text-teal-400 font-medium">${window.userRole} Access Level</p>
                    </div>

                    <!-- Navigation -->
                    <nav class="flex-grow p-4 space-y-2 overflow-y-auto">
                        ${navHtml}
                    </nav>

                    <!-- Logout -->
                    <div class="p-4 border-t border-gray-800">
                        <button 
                            onclick="window.handleLogout()"
                            class="w-full flex items-center p-3 rounded-lg text-red-400 hover:bg-gray-800 transition duration-150"
                        >
                            ${renderIcon('log-out', 'w-5 h-5 mr-3')}
                            <span class="font-medium">Logout (Simulated)</span>
                        </button>
                    </div>
                </div>
            `;
        }

        function renderDashboardOverview() {
            const totalViews = window.articles.reduce((sum, a) => sum + a.views, 0);
            const publishedCount = window.articles.filter(a => a.status === 'Published').length;
            const pendingCount = window.articles.filter(a => a.status === 'Pending Review').length;
            const activeUsers = window.MOCK_USERS.filter(u => u.status === 'Active').length;

            const recentArticlesRows = window.articles.slice(0, 3).map((article) => `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">${article.title}</td>
                    <td class="px-4 py-3 whitespace-nowrap">${getStatusBadge(article.status)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${article.views.toLocaleString()}</td>
                </tr>
            `).join('');


            return `
                <div class="space-y-8">
                    <h2 class="text-3xl font-bold text-gray-900 dark:text-white">Dashboard Overview</h2>
                    
                    <!-- Analytics Summary -->
                    <div class="grid md:grid-cols-4 gap-6">
                        ${createStatCard("Total Views (Live)", totalViews, 'TrendingUp', 'text-teal-500', 12.5)}
                        ${createStatCard("Published Articles", publishedCount, 'FileText', 'text-indigo-500', null)}
                        ${createStatCard("Pending Review", pendingCount, 'CheckCircle', 'text-amber-500', null)}
                        ${createStatCard("Active Users", activeUsers, 'Users', 'text-red-500', -3.1)}
                    </div>

                    <!-- Recent Activity & Drafts -->
                    <div class="grid lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-white dark:bg-dark-card p-6 rounded-xl shadow-lg border dark:border-gray-700">
                            <h3 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">Recent Articles (Live)</h3>
                            ${window.articles.length > 0 ? `
                                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                    <thead class="bg-gray-50 dark:bg-gray-700">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Title</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Views</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                                        ${recentArticlesRows}
                                    </tbody>
                                </table>
                            ` : `<p class="text-gray-500 dark:text-gray-400">No articles found in the database. Add one!</p>`}
                        </div>

                        <!-- Pending Tasks -->
                        <div class="bg-white dark:bg-dark-card p-6 rounded-xl shadow-lg border dark:border-gray-700">
                            <h3 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">User ID</h3>
                             <p class="text-xs break-all text-gray-700 dark:text-gray-300" title="This ID is used for private data paths and shared data attribution.">
                                ${window.userId || 'N/A (Auth Pending)'}
                            </p>
                            <h3 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white pt-4 border-t dark:border-gray-700 mt-4">Pending Tasks</h3>
                            <ul class="space-y-3">
                                <li class="flex justify-between items-center text-sm text-gray-700 dark:text-gray-300">
                                    <span>${pendingCount} Articles Pending Review</span>
                                    <span onclick="window.setCurrentPage('articles')" class="text-teal-500 font-semibold cursor-pointer hover:underline">Review Now</span>
                                </li>
                                <li class="flex justify-between items-center text-sm text-gray-700 dark:text-gray-300">
                                    <span>Update 'About Us' Page Copy</span>
                                    <span onclick="window.setCurrentPage('settings')" class="text-teal-500 font-semibold cursor-pointer hover:underline">Go to Settings</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderRichTextEditor(article) {
            const articleData = window.articles.find(a => a.id === article.id) || { title: 'New Draft', content: 'Start writing here...', category: 'Tech' };
            const articleTitle = articleData.title;
            const articleContent = articleData.content;
            const articleCategory = articleData.category;
            const isNew = article.id === 'new';

            const toolbarButtons = [
                { icon: 'Bold', title: 'Bold' }, { icon: 'Italic', title: 'Italic' },
                { icon: 'Link', title: 'Link' }, { icon: 'List', title: 'List' },
                { icon: 'Image', title: 'Image Embed' }, { icon: 'Code', title: 'Markdown/Code' },
            ];

            const toolbarHtml = toolbarButtons.map((btn) => `
                <button
                    onclick="console.log('Simulated ${btn.title} action')"
                    class="p-2 rounded-lg text-gray-600 dark:text-gray-300 hover:bg-teal-500 hover:text-white transition duration-150"
                    aria-label="Simulate ${btn.title} action"
                >
                    ${renderIcon(btn.icon, 'w-5 h-5')}
                </button>
            `).join('');
            
            const categoryOptions = window.MOCK_CATEGORIES.map(c => 
                `<option value="${c.name}" ${articleCategory === c.name ? 'selected' : ''}>${c.name}</option>`
            ).join('');

            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-3xl font-bold text-gray-900 dark:text-white">${isNew ? 'Create New Article' : `Editing: ${articleTitle}`}</h2>
                        <button onclick="window.setEditingArticle(null)" class="flex items-center text-sm font-semibold text-gray-600 dark:text-gray-400 hover:text-teal-500 transition">
                            ${renderIcon('x-circle', 'w-4 h-4 mr-1')} Back to List
                        </button>
                    </div>
                    
                    <form id="article-form" onsubmit="event.preventDefault(); 
                        window.saveArticle(
                            document.getElementById('article-title').value, 
                            document.getElementById('article-category').value, 
                            document.getElementById('article-content').value,
                            '${article.id}'
                        )">
                        <!-- Article Metadata Form -->
                        <div class="bg-white dark:bg-dark-card p-6 rounded-xl shadow-lg border dark:border-gray-700 grid sm:grid-cols-2 gap-4 mb-6">
                            <input type="text" id="article-title" required placeholder="Article Title" value="${articleTitle}" class="col-span-2 p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                            <select id="article-category" class="p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                ${categoryOptions}
                            </select>
                            <input type="text" placeholder="Featured Image URL" value="https://placehold.co/600x400/00A89A/ffffff" class="p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                            <textarea placeholder="Short Blurb / SEO Description" rows="2" class="col-span-2 p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">SEO description for the article...</textarea>
                        </div>
                        
                        <!-- Rich Text Editor -->
                        <div class="bg-white dark:bg-dark-card rounded-xl shadow-lg border dark:border-gray-700 p-4">
                            <div class="flex space-x-2 pb-3 border-b border-gray-200 dark:border-gray-700 mb-4">
                                ${toolbarHtml}
                            </div>
                            <textarea
                                id="article-content"
                                required
                                rows="15"
                                placeholder="Start writing your article here (supports Markdown)..."
                                class="rich-text-editor-textarea w-full text-lg p-4 border-none focus:ring-0 bg-transparent resize-none dark:text-white placeholder-gray-400"
                            >${articleContent}</textarea>
                            <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200 dark:border-gray-700">
                                <button type="submit" class="px-5 py-2 rounded-lg bg-gray-500 dark:bg-gray-700 text-white font-semibold hover:bg-gray-600 dark:hover:bg-gray-600 transition">Save Draft</button>
                                <button type="submit" class="px-5 py-2 rounded-lg bg-teal-500 text-white font-semibold hover:bg-teal-600 transition">Publish</button>
                            </div>
                        </div>
                    </form>
                </div>
            `;
        }

        function renderArticleManagement() {
            if (editingArticle) {
                return renderRichTextEditor(editingArticle);
            }

            const articleRows = window.articles.map((article) => `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                    <td class="px-4 py-3 text-sm font-medium text-gray-900 dark:text-white">${article.title}</td>
                    <td class="px-4 py-3 text-sm text-gray-500 dark:text-gray-400">${article.category}</td>
                    <td class="px-4 py-3">${getStatusBadge(article.status)}</td>
                    <td class="px-4 py-3 text-sm text-gray-500 dark:text-gray-400">${article.date ? new Date(article.date.seconds * 1000).toLocaleDateString() : 'N/A'}</td>
                    <td class="px-4 py-3 text-sm text-gray-500 dark:text-gray-400">${article.views.toLocaleString()}</td>
                    <td class="px-4 py-3 text-sm font-medium">
                        <button onclick="window.setEditingArticle({ id: '${article.id}' })" class="text-teal-500 hover:text-teal-700 dark:hover:text-teal-400 transition">Edit</button>
                        <span class="text-gray-300 dark:text-gray-600 mx-2">|</span>
                        <button onclick="window.deleteArticle('${article.id}')" class="text-red-500 hover:text-red-700 dark:hover:text-red-400 transition">Delete</button>
                    </td>
                </tr>
            `).join('');

            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-3xl font-bold text-gray-900 dark:text-white">Article Management (Live)</h2>
                        <button 
                            onclick="window.setEditingArticle({ id: 'new', title: 'New Draft', category: 'Tech' })"
                            class="flex items-center px-4 py-2 bg-teal-500 text-white rounded-lg font-semibold hover:bg-teal-600 transition shadow-md"
                        >
                            ${renderIcon('file-text', 'w-5 h-5 mr-2')} Create New Article
                        </button>
                    </div>

                    <div class="bg-white dark:bg-dark-card p-6 rounded-xl shadow-lg border dark:border-gray-700 overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Title</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Category</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Date</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Views</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                                ${articleRows}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        // Renderers for other pages (simplified as they rely on mock data only)
        function renderMediaManagement() { /* ... content ... */ return `<div class="p-6 text-gray-600 dark:text-gray-400">Media Management (Simulated - No Firestore required)</div>`; }
        function renderCategoryManagement() { /* ... content ... */ return `<div class="p-6 text-gray-600 dark:text-gray-400">Category Management (Simulated - No Firestore required)</div>`; }
        function renderUserManagement() { /* ... content ... */ return `<div class="p-6 text-gray-600 dark:text-gray-400">User Management (Simulated - No Firestore required)</div>`; }
        function renderSettingsPage() { /* ... content ... */ return `<div class="p-6 text-gray-600 dark:text-gray-400">Settings (Simulated - No Firestore required)</div>`; }


        function renderContent() {
            let contentHtml = '';
            switch (currentPage) {
                case 'overview': contentHtml = renderDashboardOverview(); break;
                case 'articles': contentHtml = renderArticleManagement(); break;
                case 'media': contentHtml = renderMediaManagement(); break;
                case 'categories': contentHtml = renderCategoryManagement(); break;
                case 'users': contentHtml = renderUserManagement(); break;
                case 'settings': contentHtml = renderSettingsPage(); break;
                default: contentHtml = renderDashboardOverview();
            }

            const mainContentDiv = document.getElementById('main-content');
            if (mainContentDiv) {
                mainContentDiv.innerHTML = contentHtml;
                lucide.createIcons();
            }
        }

        window.renderContent = renderContent; // Expose to the module scope
        
        function renderApp() {
            const appRoot = document.getElementById('app-root');
            appRoot.className = "flex min-h-screen bg-gray-50 dark:bg-gray-900 transition-colors duration-300 logged-in";
            
            appRoot.innerHTML = `
                ${renderSidebar()}
                <div class="flex-grow transition-all duration-300 lg:ml-64 p-4 sm:p-8">
                    <!-- Top Header/Mobile Toggle -->
                    <header class="flex justify-between items-center py-4 px-4 bg-white dark:bg-gray-800 rounded-xl shadow-md mb-8 lg:hidden">
                        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">CMS Portal</h1>
                        <button onclick="window.toggleSidebar()" class="p-2 rounded-lg text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                            ${renderIcon('menu', 'w-6 h-6')}
                        </button>
                    </header>
                    <div id="main-content">
                        <!-- Content injected by renderContent() -->
                    </div>
                </div>
            `;

            renderContent();
            lucide.createIcons();
        }

        window.renderApp = renderApp; // Expose to the module scope

        // --- INITIALIZATION START ---
        window.onload = function() {
            // Start the Firebase initialization process
            window.initFirebase();
        };

    </script>
</body>
</html>